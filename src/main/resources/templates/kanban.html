<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <link href="/css/kanban.css" rel="stylesheet" type="text/css">
    <script src="/js/kanban.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.5.0/velocity.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/muuri/0.4.0/muuri.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

</head>
<body>

<section class="kanban-demo">

    <h2 class="section-title">
        <span>Kanban Demo</span>
        <div><button onclick="addColumn()">등록</button></div>
    </h2>

    <div class="board">
        <div class="board-column todo" th:each="column, index : ${columns}" data-th-id="${column.id}" th:attrprepend="sort=${index.count}">
            <div class="board-column-header" data-th-id="${column.id}" th:text="${column.columnsName}"/>
            <button name="editButton" onclick="editColumn(this)">수정</button>
            <button name="deleteButton" onclick="deleteColumn(this)">삭제</button>
            <button name="cardAddButton" th:onclick="openAddCardModal([[${column.id}]])">카드</button>
            <div class="board-column-content">
                <div class="board-item" th:each="card : ${column.cardList}">
                    <div class="board-item-content" data-th-id="${card.id}">
                        <span class="card-info" data-th-id="${card.id}">[[${card.cardName}]]</span>
                        <button class="card-btn editButton" th:onclick="openModifyCardModal([[${card.id}]])">수정</button>
                        <button class="card-btn deleteButton" th:onclick="deleteCard([[${card.id}]])">삭제</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

</section>
<div id="addCardModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeAddCardModal()">&times;</span>
        <h2>카드 추가</h2>
        <form id="addCardForm">
            <label for="cardName">카드 이름:</label>
            <input type="text" id="cardName" name="cardName" required>

            <label for="cardDescription">카드 설명:</label>
            <textarea id="cardDescription" name="cardDescription"></textarea>

            <label for="cardColor">카드 색상:</label>
            <input type="color" id="cardColor" name="cardColor">

            <label for="file">이미지:</label>
            <input type="file" id="file" name="file">

            <label for="deadline">마감일:</label>
            <input type="date" id="deadline" name="deadline">

            <label for="worker">작업자:</label>
            <input type="text" id="worker" name="worker">

            <input type="hidden" id="addCardColumn">

            <button type="button" onclick="cardAdd()">카드 추가</button>
        </form>
    </div>
</div>

<div id="modifyCardModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModifyCardModal()">&times;</span>
        <h2>카드 수정</h2>
        <form id="modifyCardForm">
            <label for="cardName">카드 이름:</label>
            <input type="text" id="modifyCardName" name="cardName" required>

            <label for="cardDescription">카드 설명:</label>
            <textarea id="modifyCardDescription" name="cardDescription"></textarea>

            <label for="cardColor">카드 색상:</label>
            <input type="color" id="modifyCardColor" name="cardColor">

            <label for="file">이미지:</label>
            <input type="file" id="modifyFile" name="file">

            <label for="deadline">마감일:</label>
            <input type="date" id="modifyDeadline" name="deadline">

            <label for="worker">작업자:</label>
            <input type="text" id="modifyWorker" name="worker">

            <input type="hidden" id="modifyCardId">

            <button type="button" onclick="cardModify()">카드 수정</button>
        </form>
    </div>
</div>
</body>
<script th:inline="javascript">
    let columnNum = 1;
    const boardId = [[${boardId}]];

    function cardAdd(){
        let cardData = new FormData();
        cardData.append("cardName", document.getElementById('cardName').value);
        cardData.append("cardDescription", document.getElementById('cardDescription').value);
        cardData.append("cardColor", document.getElementById('cardColor').value);
        cardData.append("deadline", document.getElementById('deadline').value);
        cardData.append("worker", document.getElementById('worker').value);
        cardData.append("columns", document.getElementById('addCardColumn').value);
        cardData.append("cardOrder", "99");
        cardData.append("file", document.getElementById('file').files[0]);
        console.log(cardData);

        fetch('/api/cards', {
            method: 'POST',
            body: cardData,
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            closeAddCardModal()
            location.reload()
        })
    }

    function addColumn(){
        const newColumnName = prompt('등록할 컬럼 이름을 입력하세요.');
        if(newColumnName == null) return;

        document.querySelector(".board").insertAdjacentHTML('beforeend', `
            <div class="board-column todo">
                <div class="board-column-header">
                ${newColumnName}
                </div>
                <button name="editButton" onclick="editColumn(this)">수정</button>
                <button name="deleteButton" onclick="deleteColumn(this)">삭제</button>
                <button name="cardAddButton" onclick="openAddCardModal(this)">카드</button>
                <div class="board-column-content">
                </div>
            </div>
        `);

        columnNum ++;
        kanbanRelaod();

        fetch('/api/user/boards/'+ boardId + '/columns', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                "board":{
                    "id":boardId
                },
                "columnsName":newColumnName,
                "columnsOrder":1
            }),
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }


    function editColumn(button) {
        const columnId = button.parentNode.getAttribute("id");
        const newColumnName = prompt('새로운 컬럼 이름을 입력하세요:', button.parentNode.childNodes[1].textContent);

        if (columnId !== null) {
            const data = {
                columnsName: newColumnName
            };

            fetch('/api/user/boards/'+ boardId + '/columns/' + columnId, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(() => {
                button.parentNode.childNodes[1].textContent = newColumnName;
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    }

    function deleteColumn(button) {
        const columnDiv = button.closest('.todo');
        const headerElement = columnDiv.querySelector('.board-column-header');
        const columnId = headerElement.getAttribute('id');
        const confirmDelete = confirm('삭제하시겠습니까?');
        if (confirmDelete) {
            fetch('/api/user/boards/columns/' + columnId, {
                method : 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`)
                }
                alert('삭제완료');
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    }

    function kanbanRelaod() {
        var docElem = document.documentElement;
        var kanban = document.querySelector('.kanban-demo');
        var board = kanban.querySelector('.board');
        var itemContainers = Array.prototype.slice.call(kanban.querySelectorAll('.board-column-content'));
        var columnGrids = [];
        var dragCounter = 0;
        var boardGrid;

        itemContainers.forEach(function (container) {

            var muuri = new Muuri(container, {
                items: '.board-item',
                layoutDuration: 400,
                layoutEasing: 'ease',
                dragEnabled: true,
                dragSortInterval: 0,
                dragSortGroup: 'column',
                dragSortWith: 'column',
                dragContainer: document.body,
                dragReleaseDuration: 400,
                dragReleaseEasing: 'ease'
            })
                .on('dragStart', function (item) {
                    ++dragCounter;
                    docElem.classList.add('dragging');
                    item.getElement().style.width = item.getWidth() + 'px';
                    item.getElement().style.height = item.getHeight() + 'px';
                })
                .on('dragEnd', function (item) {
                    if (--dragCounter < 1) {
                        docElem.classList.remove('dragging');

                    }
                })
                .on('dragReleaseEnd', function (item) {
                    item.getElement().style.width = '';
                    item.getElement().style.height = '';
                    columnGrids.forEach(function (muuri) {
                        muuri.refreshItems();
                    });

                })
                .on('layoutStart', function () {
                    boardGrid.refreshItems().layout();
                });

            columnGrids.push(muuri);

        });

        boardGrid = new Muuri(board, {
            layoutDuration: 400,
            layoutEasing: 'ease',
            dragEnabled: true,
            dragSortInterval: 0,
            dragStartPredicate: {
                handle: '.board-column-header'
            },
            dragReleaseDuration: 400,
            dragReleaseEasing: 'ease'
        });

    }

    // Add Card Modal
    const addCardModal = document.getElementById('addCardModal');
    const addCardForm = document.getElementById('addCardForm');

    function openAddCardModal(columnId) {
        document.querySelector("#addCardColumn").value = columnId;
        addCardModal.style.display = 'block';
    }

    function closeAddCardModal() {
        addCardForm.reset();
        addCardModal.style.display = 'none';
    }

    const cardInfoList = document.querySelectorAll(".card-info");
    [].forEach.call(cardInfoList, (el) => {
        el.addEventListener("click", (el) => {
            const url = "/cards/"+el.target.getAttribute("id");
            const name = "popup test";
            const option = "width = 1440, height = 765, top = 100, left = 200, location = no"
            window.open(url, name, option);
        });
    });

    const modfiyCardModal = document.getElementById('modifyCardModal');
    const modifyCardForm = document.getElementById('modifyCardForm');

    function closeModifyCardModal() {
        modifyCardForm.reset();
        modfiyCardModal.style.display = 'none';
    }

    function openModifyCardModal(cardId){
        // 패치로 조회 하고
        fetch('/api/cards/' + cardId, {
            method : 'GET'
        })
        .then(async response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`)
            }
            let json = await response.json();
            document.querySelector("#modifyCardName").value = json.cardName;
            document.querySelector("#modifyCardDescription").value = json.cardDescription;
            document.querySelector("#modifyCardColor").value = json.cardColor;
            document.querySelector("#modifyDeadline").value = json.deadline;
            document.querySelector("#modifyWorker").value = json.worker;
            document.querySelector("#modifyCardId").value = cardId;
            modfiyCardModal.style.display = 'block';
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    function deleteCard(cardId){
        const confirmDelete = confirm('카드 삭제하시겠습니까?');
        if (confirmDelete) {
            fetch('/api/cards/' + cardId, {
                method : 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`)
                }
                alert('카드 삭제완료');
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    }
</script>
</html>